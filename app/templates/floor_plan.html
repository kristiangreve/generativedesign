{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.11.5/paper-full.js"></script>
  <script type = "text/javascript" src="{{ url_for('static', filename='vis/dist/vis.js') }}"></script>
  <link href = "{{ url_for('static', filename='vis/dist/vis.css') }}" rel="stylesheet" type="text/css" />
</head>

<style type="text/css">
  canvas {
    background-color: white;
    width: 100%;
    height: auto;
  }
  .network {
    height: 300px;
    width: 100%;
  }
  .subnetwork {
    height: 200px;
    width: 100%;
  }
</style>

<p></p>
<div class="row">
  <div class="col-md-7">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Suggested floor plan</h5>
        <canvas class="floor_canvas" id="canvas_1" width="300" height="100"></canvas>
        <button id="generate_button" class="btn btn-primary">Generate new layout</button>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Groups</h5>
        <div class="network" id="group_network"></div>
      </div>
    </div>
  </div>
</div>
<p></p>
<div class="row">
  <div class="col-md-7">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Add group</h5>
        <div class="row">
          <div class="col-md-4">
            <input name = "name_of_group" id="name_of_group" type="text" class="form-control">
          </div>
          <div class="col-md-4">
            <button id="add_group_button" class="btn btn-primary">New group</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-5" id = 'groups'>
  </div>
  <div class="col-md-7" style="display: none;">
    <div class="card">
      <div class="card-body">
        <canvas id="canvas_plot"></canvas>
      </div>
    </div>
  </div>

  <script type="text/javascript">

    var options = {
      "nodes": {
        "shape": "dot"
      },
      "edges": {
        "smooth": {
          "forceDirection": "none"
        }
      },
      "interaction": {
        "dragNodes": false,
        "dragView": false,

        "selectConnectedEdges": false,
        "hoverConnectedEdges": false,
        "zoomView": false
      },
      "physics": {
        "forceAtlas2Based": {
          "gravitationalConstant": -20,
          "springLength": 10,
          "springConstant": 0.05,
          "avoidOverlap": 1
        },
        "minVelocity": 0.75,
        "solver": "forceAtlas2Based",
        "timestep": 1
      }
    }

    options.groups = {
    myGroup: {color:{background:'red'}, borderWidth:3}
  }

    // create a net


    // burde tage et id som input m√•ske
    function update_network(group){

      var adding = false;
      var from_node = 0;
      var to_node = 0;

      var data = {
        nodes: group.nodes,
        edges: group.edges
      };

      var container = document.getElementById(group.name);
      var network = new vis.Network(container, data, options);

      network.on("selectEdge", function (params) {
        console.log('selected edge:', params.edges[0]);
        console.log('edges of group', group.edges);
        var index =	group.edges.findIndex(function(edge) {
          return (edge.id == params.edges[0]);
        });
        group.edges.splice(index,1);
        update_network(group);
      });

      network.on("selectNode", function (params) {
        if(adding == false){
          adding = true;
          from_node = params.nodes[0];
        } else {
          adding = false;
          to_node = params.nodes[0];

          var index =	group.edges.findIndex(function(el) {
            return (el.to == from_node && el.from == to_node ||
            el.to == to_node && el.from == from_node)
          });

          if (index == -1){
            if (from_node != to_node){
              group.edges.push({from:from_node,to:to_node});
              console.log("group edges",group.edges);
              update_network(group);
            };
          };
        }
      });
    };

    function update_group_network(groups,edges_of_groups){
      var adding = false;
      var from_node = 0;
      var to_node = 0;

      // adding the overall group edges to the edge array
      group_nodes = [];
      groups.forEach(function(group) {
        node_dict = {id: group.name, label: group.name, group: group.name};
        group_nodes.push(node_dict)
      });

      var data = {
        nodes: group_nodes,
        edges: edges_of_groups
      };

      var container = document.getElementById('group_network');
      var network = new vis.Network(container, data, options);

      network.on("selectEdge", function (params) {
        var index =	edges_of_groups.findIndex(function(edge) {
          return (edge.id == params.edges[0]);
        });
        edges_of_groups.splice(index,1);
        update_group_network(groups,edges_of_groups)
      });

      network.on("selectNode", function (params) {
        if(adding == false){
          adding = true;
          from_node = params.nodes[0];
        } else {
          adding = false;
          to_node = params.nodes[0];
          var index =	edges_of_groups.findIndex(function(el) {
            return (el.to == from_node && el.from == to_node ||
            el.to == to_node && el.from == from_node)
          });
          console.log("clicked, index: ",index)
          if(index == -1){
            if (from_node != to_node){
              console.log("clicked, index: ",index)

              edges_of_groups.push({from:from_node,to:to_node});

              update_group_network(groups,edges_of_groups);

            };
          };
        };
      });
    };

  </script>

  <script type="text/paperscript" canvas='canvas_plot' src = "{{ url_for('static', filename='js/floor_plan.js') }}"></script>

  {% endblock %}
